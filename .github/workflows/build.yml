# .github/workflows/main.yml

name: Build Xposed Module

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 步骤4: 使用更稳健的 Heredoc 方式创建所有项目文件
      - name: Create Project Structure and Files
        run: |
          PACKAGE_NAME="com.creeperhs.shortcuthook"
          PACKAGE_PATH="app/src/main/java/com/example/shortcuthook"

          mkdir -p app/src/main/assets
          mkdir -p "${PACKAGE_PATH}"

          # --- 创建项目级 build.gradle ---
          cat <<EOF > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath "com.android.tools.build:gradle:8.3.2"
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22"
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF

          # --- 创建应用级 app/build.gradle ---
          cat <<EOF > app/build.gradle
          plugins {
              id "com.android.application"
              id "kotlin-android"
          }
          android {
              namespace = "${PACKAGE_NAME}"
              compileSdk = 34
              defaultConfig {
                  applicationId = "${PACKAGE_NAME}"
                  minSdk = 21
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_1_8
                  targetCompatibility = JavaVersion.VERSION_1_8
              }
              kotlinOptions {
                  jvmTarget = "1.8"
              }
          }
          repositories {
              maven { url "https://api.xposed.info/" }
          }
          dependencies {
              compileOnly "de.robv.android.xposed:api:82"
          }
          EOF

          # --- 创建 settings.gradle (修正了这里的语法问题) ---
          cat <<EOF > settings.gradle
          rootProject.name = 'MyXposedModule'
          include ':app'
          EOF

          # --- 创建 AndroidManifest.xml ---
          cat <<EOF > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application android:label="系统事件拦截">
                  <meta-data
                      android:name="xposedmodule"
                      android:value="true" />
                  <meta-data
                      android:name="xposeddescription"
                      android:value="这是一个用来屏蔽 Alt+Tab 和 Win 键的Xposed模块 by Creeperhs" />
                  <meta-data
                      android:name="xposedminversion"
                      android:value="82" />
              </application>
          </manifest>
          EOF

          # --- 创建 xposed_init 文件 ---
          echo "${PACKAGE_NAME}.ShortcutHook" > app/src/main/assets/xposed_init

          # --- 创建你的Kotlin代码文件 ---
          cat <<EOF > "${PACKAGE_PATH}/ShortcutHook.kt"
          package com.example.shortcuthook

          import android.view.KeyEvent
          import de.robv.android.xposed.IXposedHookLoadPackage
          import de.robv.android.xposed.XC_MethodHook
          import de.robv.android.xposed.XposedHelpers
          import de.robv.android.xposed.callbacks.XC_LoadPackage

          class ShortcutHook : IXposedHookLoadPackage {

              override fun handleLoadPackage(lpparam: XC_LoadPackage.LoadPackageParam) {
                  if (lpparam.packageName != "android") return
                  hook("interceptSystemKeysAndShortcutsOld", lpparam.classLoader)
                  hook("interceptSystemKeysAndShortcutsNew", lpparam.classLoader)
              }

              private fun hook(method: String, cl: ClassLoader) {
                  try {
                      XposedHelpers.findAndHookMethod(
                          "com.android.server.policy.PhoneWindowManager",
                          cl,
                          method,
                          android.os.IBinder::class.java,
                          KeyEvent::class.java,
                          object : XC_MethodHook() {
                              override fun beforeHookedMethod(param: MethodHookParam) {
                                  val e = param.args[1] as KeyEvent
                                  
                                  if (e.keyCode == KeyEvent.KEYCODE_TAB &&
                                      e.metaState and KeyEvent.META_ALT_ON != 0
                                  ) {
                                      param.result = true
                                      return
                                  }
                                  
                                  if (e.keyCode == KeyEvent.KEYCODE_META_LEFT ||
                                      e.keyCode == KeyEvent.KEYCODE_META_RIGHT
                                  ) {
                                      param.result = true
                                      return
                                  }
                              }
                          }
                      )
                  } catch (_: Throwable) {}
              }
          }
          EOF

          # --- 下载并指定一个兼容的 Gradle 版本 ---
          gradle wrapper --gradle-version 8.4 --distribution-type all

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ShortcutHook-Module-APK
          path: app/build/outputs/apk/release/app-release-unsigned.apk
